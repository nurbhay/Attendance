<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Attendance Tracker</title>

<style>
body{font-family:Arial;background:#0f172a;color:#e5e7eb;margin:0;padding:12px}
.card{background:#020617;border-radius:10px;padding:12px;margin-bottom:12px}
button{padding:6px 10px;border:none;border-radius:6px;margin:4px;cursor:pointer}
.present{background:#22c55e}
.absent{background:#ef4444}
.cancelled{background:#6b7280}
.locked{opacity:.6;pointer-events:none}
select,input[type=date]{padding:6px;border-radius:6px;border:none;width:100%}
.progress-bg{background:#334155;height:10px;border-radius:8px;overflow:hidden}
.progress-fill{height:100%;transition:width .4s,background .4s}
.green{background:#22c55e}
.yellow{background:#facc15}
.red{background:#ef4444}
</style>
</head>

<body>

<h2>üìä Smart Attendance Tracker</h2>

<div class="card" id="todayInfo"></div>

<div class="card">
<h3>üìö Today‚Äôs Lectures</h3>
<div id="lectures"></div>
</div>

<div class="card">
<h3>‚ûï Extra Lecture</h3>
<select id="extraSubject"></select><br>
<button class="present" onclick="markExtra('Present')">Present</button>
<button class="absent" onclick="markExtra('Absent')">Absent</button>
<button onclick="lockExtra()">No Extra Lecture</button>
</div>

<div class="card">
<h3>üìà Attendance Summary</h3>
<div id="summary"></div>
</div>

<div class="card">
<h3>üîç Detailed Attendance</h3>
<select id="viewMode" onchange="renderDetailView()">
<option value="date">Date Wise</option>
<option value="subject">Subject Wise</option>
</select>
<div id="filterArea"></div>
<div id="detailResult"></div>
</div>

<div class="card">
<h3>‚è™ Add Past Attendance</h3>
<input type="date" id="pastDate">
<div id="pastLectures"></div>
<button onclick="savePastAttendance()">Save Past Attendance</button>
</div>

<div class="card">
<h3>üíæ Backup</h3>
<button onclick="exportBackup()">Export Backup</button>
<input type="file" id="importFile" hidden>
<button onclick="document.getElementById('importFile').click()">Import Backup</button>
</div>

<script>
/* ===== DATE KEY (SINGLE SOURCE OF TRUTH) ===== */
function makeDateKey(d){
  const dt = (d instanceof Date) ? d : new Date(d);
  return `${dt.getFullYear()}-${String(dt.getMonth()+1).padStart(2,'0')}-${String(dt.getDate()).padStart(2,'0')}`;
}
function displayDate(k){
  const d=new Date(k);
  return d.toLocaleDateString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric",weekday:"long"});
}

/* ===== DATA ===== */
let data = JSON.parse(localStorage.getItem("attendanceData")) || {
  totals:{}, history:{}, locks:{}, extra:{}
};
function save(){localStorage.setItem("attendanceData",JSON.stringify(data));}

/* ===== TIMETABLE ===== */
const timetable={
  Monday:[["11:00-12:00","Cyber Law"],["12:00-01:00","AI"]],
  Tuesday:[["11:00-12:00","Cyber Law"]]
};

const today=new Date();
const day=today.toLocaleDateString("en-US",{weekday:"long"});
const dateKey=makeDateKey(today);

/* ===== TODAY INFO ===== */
document.getElementById("todayInfo").innerHTML=
  timetable[day]?`üìÖ ${displayDate(dateKey)}`:`üü° Weekend<br>No lectures today`;

/* ===== LOAD LECTURES ===== */
function loadLectures(){
  const box=document.getElementById("lectures");
  box.innerHTML="";
  (timetable[day]||[]).forEach(([t,s])=>{
    const k=`${dateKey}_${s}_${t}`;
    const locked=data.locks[k];
    const d=document.createElement("div");
    d.className="card"+(locked?" locked":"");
    d.innerHTML=`<b>${t}</b> ${s}<br>
      <button class="present">Present</button>
      <button class="absent">Absent</button>
      <button class="cancelled">Cancelled</button>`;
    d.querySelectorAll("button").forEach(b=>{
      b.onclick=()=>markAttendance(s,t,b.innerText);
    });
    box.appendChild(d);
  });
}

/* ===== MARK ===== */
function markAttendance(s,t,st){
  const k=`${dateKey}_${s}_${t}`;
  if(data.locks[k])return;
  data.locks[k]=true;
  data.history[dateKey]??=[];
  data.history[dateKey].push({subject:s,time:t,status:st});
  if(st!=="Cancelled"){
    data.totals[s]??={p:0,t:0};
    data.totals[s].t++;
    if(st==="Present")data.totals[s].p++;
  }
  save();loadLectures();renderSummary();
}

/* ===== SUMMARY ===== */
function renderSummary(){
  const s=document.getElementById("summary");
  s.innerHTML="";
  let tp=0,tt=0;
  Object.entries(data.totals).forEach(([k,v])=>{
    const p=Math.round(v.p/v.t*100);
    tp+=v.p;tt+=v.t;
    const c=p<60?"red":p<75?"yellow":"green";
    s.innerHTML+=`${k} ${v.p}/${v.t} (${p}%)<div class="progress-bg">
      <div class="progress-fill ${c}" style="width:${p}%"></div></div><br>`;
  });
  if(tt) s.innerHTML+=`<b>Overall ${Math.round(tp/tt*100)}%</b>`;
}

/* ===== DETAIL VIEW (UNCHANGED LOGIC) ===== */
function renderDetailView(){
  const mode=document.getElementById("viewMode").value;
  const f=document.getElementById("filterArea");
  const r=document.getElementById("detailResult");
  f.innerHTML="";r.innerHTML="";
  if(mode==="date"){
    const d=Object.keys(data.history);
    if(!d.length){r.innerText="No data";return;}
    f.innerHTML=`<select onchange="showDateWise(this.value)">
      <option value="">Select Date</option>
      ${d.map(x=>`<option value="${x}">${displayDate(x)}</option>`).join("")}
    </select>`;
  }else{
    const s=Object.keys(data.totals);
    if(!s.length){r.innerText="No data";return;}
    f.innerHTML=`<select onchange="showSubjectWise(this.value)">
      <option value="">Select Subject</option>
      ${s.map(x=>`<option>${x}</option>`).join("")}
    </select>`;
  }
}
function showDateWise(d){
  if(!d)return;
  const r=document.getElementById("detailResult");
  r.innerHTML=`<b>${displayDate(d)}</b><br>`;
  data.history[d].forEach(h=>r.innerHTML+=`${h.subject} ${h.time} - ${h.status}<br>`);
}
function showSubjectWise(s){
  if(!s)return;
  const r=document.getElementById("detailResult");
  r.innerHTML="";
  Object.entries(data.history).forEach(([d,l])=>{
    l.filter(h=>h.subject===s).forEach(h=>{
      r.innerHTML+=`${displayDate(d)} ${h.time} - ${h.status}<br>`;
    });
  });
}

/* ===== PAST ATTENDANCE (FIXED) ===== */
let pastBuffer=[],pastDateKey="";
document.getElementById("pastDate").onchange=e=>{
  pastDateKey=makeDateKey(e.target.value);
  if(data.history[pastDateKey]){
    alert("Attendance already exists for this date");
    return;
  }
  pastBuffer=[];
  const box=document.getElementById("pastLectures");
  box.innerHTML="";
  const wd=new Date(pastDateKey).toLocaleDateString("en-US",{weekday:"long"});
  (timetable[wd]||[]).forEach(([t,s])=>{
    const d=document.createElement("div");
    d.innerHTML=`${t} ${s}
      <button class="present">Present</button>
      <button class="absent">Absent</button>
      <button class="cancelled">Cancelled</button>`;
    d.querySelectorAll("button").forEach(b=>{
      b.onclick=()=>pastBuffer.push({subject:s,time:t,status:b.innerText});
    });
    box.appendChild(d);
  });
};

function savePastAttendance(){
  if(!pastDateKey||!pastBuffer.length)return;
  if(data.history[pastDateKey]){
    alert("Attendance already exists for this date");
    return;
  }
  data.history[pastDateKey]=[];
  pastBuffer.forEach(h=>{
    data.history[pastDateKey].push(h);
    if(h.status!=="Cancelled"){
      data.totals[h.subject]??={p:0,t:0};
      data.totals[h.subject].t++;
      if(h.status==="Present")data.totals[h.subject].p++;
    }
  });
  save();location.reload();
}

/* ===== BACKUP ===== */
function exportBackup(){
  const b=new Blob([JSON.stringify(data)],{type:"application/json"});
  const a=document.createElement("a");
  a.href=URL.createObjectURL(b);
  a.download="attendance_backup.json";
  a.click();
}
document.getElementById("importFile").onchange=e=>{
  const r=new FileReader();
  r.onload=()=>{data=JSON.parse(r.result);save();location.reload();};
  r.readAsText(e.target.files[0]);
};

/* INIT */
loadLectures();renderSummary();renderDetailView();
</script>
</body>
</html>
