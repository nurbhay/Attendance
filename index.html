<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Smart Attendance Tracker</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<link rel="apple-touch-icon" href="icon.png">

<style>
body { font-family: Arial, sans-serif; background: #0f172a; color: #e5e7eb; margin: 0; padding: 10px; }
h1, h2 { text-align: center; }
.card { background: #1e293b; padding: 10px; margin-bottom: 10px; border-radius: 8px; }
button { margin: 4px; padding: 6px 10px; border: none; border-radius: 5px; cursor: pointer; }
.present { background: #16a34a; color: white; }
.absent { background: #dc2626; color: white; }
.cancelled { background: #6b7280; color: white; }
.note-btn { background: #f59e0b; color: #1e293b; font-weight: bold; } /* New Note Button */
.locked { opacity: 0.6; pointer-events: none; }
select { padding: 6px; margin-top: 5px; width: 100%; max-width: 300px; }
.reset-btn { background: #7c2d12; color: white; width: 100%; padding: 10px; margin-top: 20px; }

/* HEADER & SETTINGS BTN */
.header-container { display: flex; justify-content: center; align-items: center; position: relative; margin-bottom: 10px; }
.settings-btn { position: absolute; right: 0; top: 0; background: none; font-size: 24px; cursor: pointer; padding: 5px; }

/* MODAL STYLES */
.modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 1000; justify-content: center; align-items: center; }
.modal-content { background: #1e293b; padding: 20px; border-radius: 12px; width: 90%; max-width: 400px; max-height: 85vh; overflow-y: auto; border: 1px solid #334155; }
.modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
.close-modal { background: none; font-size: 24px; color: #ef4444; cursor: pointer; }
.edit-row { display: flex; gap: 5px; margin-bottom: 8px; align-items: center; }
.edit-input { background: #0f172a; border: 1px solid #334155; color: white; padding: 8px; border-radius: 5px; width: 100%; }
.time-input { width: 35%; }
.sub-input { width: 65%; }
.del-row-btn { background: #ef4444; color: white; padding: 5px 10px; font-size: 12px; }
.add-row-btn { background: #2563eb; color: white; width: 100%; padding: 8px; margin-top: 10px; }
.save-btn { background: #16a34a; color: white; width: 100%; padding: 10px; margin-top: 10px; font-weight: bold; }
.restore-btn { background: #64748b; color: white; width: 100%; padding: 8px; margin-top: 20px; font-size: 12px; }

/* TASK LIST STYLES */
.task-item { display: flex; justify-content: space-between; align-items: center; background: #0f172a; padding: 8px; margin-bottom: 6px; border-radius: 6px; border-left: 4px solid #f59e0b; }
.task-text { font-size: 14px; flex-grow: 1; margin-right: 10px; }
.task-sub { font-size: 11px; color: #9ca3af; display: block; margin-top: 2px; }
.task-done { opacity: 0.5; text-decoration: line-through; border-left-color: #16a34a; }
.del-task-btn { background: none; color: #ef4444; font-size: 16px; padding: 0 5px; }

/* SUMMARY & BARS */
.summary-item { padding: 12px 0; border-bottom: 1px solid #334155; }
.summary-item:last-child { border-bottom: none; }
.subject-row { display: flex; justify-content: space-between; align-items: center; font-size: 14px; }
.subject-name { font-weight: 600; color: #e5e7eb; }
.subject-stats { color: #9ca3af; font-size: 13px; }
.progress-wrap { margin-top: 6px; }
.progress-bar-bg { width: 100%; height: 10px; background: #334155; border-radius: 6px; overflow: hidden; }
.progress-bar-fill { height: 100%; border-radius: 6px; transition: width 0.3s ease; }
.progress-green { background: #22c55e; }
.progress-yellow { background: #facc15; }
.progress-red { background: #ef4444; }

/* STATUS MESSAGES */
.status-msg { font-size: 12px; margin-top: 5px; font-weight: 600; letter-spacing: 0.3px; }
.msg-safe { color: #4ade80; } 
.msg-danger { color: #f87171; } 
.msg-warning { color: #facc15; }
.msg-cancelled { color: #9ca3af; }

/* OVERALL BAR */
.overall-container { margin-top: 22px; padding: 14px; background: linear-gradient(135deg, #020617, #0f172a); border-radius: 12px; border: 1px solid #334155; }
.overall-title { text-align: center; font-size: 14px; color: #cbd5f5; margin-bottom: 8px; letter-spacing: 0.5px; }
.overall-bar-bg { width: 100%; height: 16px; background: #334155; border-radius: 10px; overflow: hidden; }
.overall-bar-fill { height: 100%; border-radius: 10px; transition: width 0.4s ease, background 0.4s ease; }
.overall-percent { margin-top: 8px; text-align: center; font-size: 18px; font-weight: bold; }
.overall-green { background: linear-gradient(90deg, #22c55e, #4ade80); }
.overall-yellow { background: linear-gradient(90deg, #facc15, #fde047); }
.overall-red { background: linear-gradient(90deg, #ef4444, #f87171); }
.overall-green-text { color: #22c55e; }
.overall-yellow-text { color: #facc15; }
.overall-red-text { color: #ef4444; }

/* CARDS */
.lecture-card { position: relative; transition: background 0.2s ease, opacity 0.2s ease; }
.lecture-card.locked { opacity: 0.75; }
.lecture-card::before { content: ""; position: absolute; left: 0; top: 0; width: 5px; height: 100%; border-radius: 8px 0 0 8px; background: transparent; }
.lecture-present::before { background: #22c55e; }
.lecture-absent::before { background: #ef4444; }
.lecture-cancelled::before { background: #9ca3af; }
.status-label { margin-top: 6px; font-size: 12px; font-weight: bold; }
.detail-item { padding: 6px 0; border-bottom: 1px solid #334155; font-size: 14px; }
.status-Present { color: #22c55e; font-weight: bold; }
.status-Absent { color: #ef4444; font-weight: bold; }
.status-Cancelled { color: #9ca3af; font-weight: bold; }
</style>
</head>

<body>

<div class="header-container">
  <h1>üìä Attendance</h1>
  <button class="settings-btn" onclick="openSettings()">‚öôÔ∏è</button>
</div>

<h2 id="today"></h2>
<div id="dayStatus" style="text-align:center;margin-bottom:10px;"></div>

<div id="lectures"></div>

<div class="card" id="taskCard" style="display:none;">
  <h3>üìù Homework & Notes</h3>
  <div id="taskList"></div>
</div>

<div class="card">
  <h3>‚ûï Extra Lecture</h3>
  <select id="extraSubject"></select>
  <br>
  <button class="present" onclick="markExtra('Present')">Present</button>
  <button class="absent" onclick="markExtra('Absent')">Absent</button>
  <br>
  <button class="cancelled" onclick="lockNoExtra()">No Extra Lectures</button>
  <div id="extraInfo" style="font-size:12px;margin-top:6px;"></div>
</div>

<div class="card">
  <h3>üìà Attendance Summary</h3>
  <div id="summary"></div>
</div>

<div class="card">
  <h3 onclick="toggleUndo()" style="cursor:pointer;">üïò Undo Attendance (Today Only) ‚ñº</h3>
  <div id="undoSection" style="display:none;"></div>
</div>

<div class="card">
  <h3>üîç Detailed View</h3>
  <select id="viewMode" onchange="renderDetailView()">
    <option value="">Select View</option>
    <option value="date">Date Wise</option>
    <option value="subject">Subject Wise</option>
  </select>
  <div id="filterArea"></div>
  <div id="detailResult" style="margin-top:10px;font-size:14px;"></div>
</div>

<div class="card">
  <h3>üïò Add Past Attendance</h3>
  <input type="date" id="pastDate" onchange="loadPastTimetable()" />
  <div id="pastLectures"></div>
  <div id="pastExtra" style="margin-top:10px;"></div>
  <button class="present" onclick="savePastAttendance()">Save Attendance</button>
</div>

<div class="card">
  <h3>üíæ Backup & Restore</h3>
  <button onclick="exportBackup()">‚¨á Export Backup</button>
  <input type="file" id="importFile" accept=".json" style="display:none">
  <button onclick="document.getElementById('importFile').click()">‚¨Ü Import Backup</button>
</div>

<button class="reset-btn" onclick="resetAll()">RESET ALL DATA</button>

<div id="settingsModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h3>‚öôÔ∏è Edit Timetable</h3>
      <button class="close-modal" onclick="closeSettings()">‚úñ</button>
    </div>
    <label>Select Day to Edit:</label>
    <select id="editDaySelect" onchange="renderEditRows()">
      <option value="Monday">Monday</option>
      <option value="Tuesday">Tuesday</option>
      <option value="Wednesday">Wednesday</option>
      <option value="Thursday">Thursday</option>
      <option value="Friday">Friday</option>
      <option value="Saturday">Saturday</option>
      <option value="Sunday">Sunday</option>
    </select>
    <div id="editContainer" style="margin-top:15px;"></div>
    <button class="add-row-btn" onclick="addEditRow()">+ Add Lecture Slot</button>
    <button class="save-btn" onclick="saveNewTimetable()">üíæ Save Changes</button>
    <hr style="border-color:#334155; margin:20px 0;">
    <button class="restore-btn" onclick="restoreDefaultTimetable()">‚ö† Restore Default Timetable</button>
  </div>
</div>

<script>
// --- CONFIGURATION ---
const PASSWORD = "Nir@2006";
const MIN_ATTENDANCE = 75; 

// --- DEFAULT TIMETABLE ---
const defaultTimetable = {
  Monday: [
    ["11:00-12:00","Introduction to Cyber Law"],
    ["12:00-01:00","Artificial Intelligence"],
    ["01:30-03:30","Operating Systems Lab"],
    ["03:30-04:30","Operating Systems"],
    ["04:30-05:30","Entrepreneurship and Start-ups"]
  ],
  Tuesday: [
    ["11:00-12:00","Introduction to Cyber Law"],
    ["12:00-01:00","Theory of Computation"],
    ["01:30-03:30","Artificial Intelligence Lab"],
    ["03:30-04:30","Operating Systems"],
    ["04:30-05:30","Business Communication"]
  ],
  Wednesday: [
    ["11:00-01:00","Computer Skill Lab-1"],
    ["01:30-02:30","Theory of Computation"],
    ["02:30-03:30","Introduction to Cyber Law"],
    ["03:30-04:30","Artificial Intelligence"],
    ["04:30-05:30","Business Communication"]
  ],
  Thursday: [
    ["11:00-12:00","Software Requirement Engineering"],
    ["12:00-01:00","Theory of Computation"],
    ["01:30-02:30","Operating Systems"],
    ["02:30-03:30","Artificial Intelligence"],
    ["03:30-04:30","Entrepreneurship and Start-ups"]
  ],
  Friday: [
    ["11:00-01:00","Software Requirement Engineering"],
    ["01:30-02:30","Theory of Computation"],
    ["02:30-04:30","Report Writing & Presentation Skill"]
  ]
};

// --- PWA INIT ---
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("./sw.js").catch(e=>console.log(e));
}

// --- LOAD DATA ---
function getStorageDateKey(date) {
  const y = date.getFullYear();
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const d = String(date.getDate()).padStart(2, '0');
  return `${y}-${m}-${d}`;
}

const today = new Date();
const day = today.toLocaleDateString("en-US",{ weekday:"long" });
const dateKey = getStorageDateKey(today);

// Data now includes 'tasks'
let data = JSON.parse(localStorage.getItem("attendance")) || { totals:{}, history:{}, locks:{}, tasks:[] };
// Ensure tasks array exists for old users
if(!data.tasks) data.tasks = [];

let timetable = JSON.parse(localStorage.getItem("custom_timetable")) || JSON.parse(JSON.stringify(defaultTimetable));

// --- CORE FUNCTIONS ---
function save(){ localStorage.setItem("attendance",JSON.stringify(data)); }

function loadLectures(){
  const container = document.getElementById("lectures");
  container.innerHTML = "";
  (timetable[day] || []).forEach(([time,subject])=>{
    const lockKey = dateKey+"_"+subject+"_"+time;
    const locked = data.locks[lockKey];
    const div = document.createElement("div");
    div.className = "card lecture-card"+(locked?"locked":"");
    // Added Note Button
    div.innerHTML = `<b>${time}</b><br>${subject}<br>
      <button class="present">Present</button>
      <button class="absent">Absent</button>
      <button class="cancelled">Cancelled</button>
      <button class="note-btn">üìù</button>`;

    if(locked && data.history[dateKey]){
      const entry = data.history[dateKey].find(h => h.subject === subject && h.time === time);
      if(entry){
        if(entry.status === "Present") div.classList.add("lecture-present");
        if(entry.status === "Absent") div.classList.add("lecture-absent");
        if(entry.status === "Cancelled") div.classList.add("lecture-cancelled");
        div.innerHTML += `<div class="status-label">${entry.status === "Present" ? "‚úî Present" : entry.status === "Absent" ? "‚úñ Absent" : "‚è∏ Cancelled"}</div>`;
      }
    }
    
    // Add Event Listeners
    const btns = div.querySelectorAll("button");
    btns[0].onclick = ()=>markAttendance(subject, time, "Present");
    btns[1].onclick = ()=>markAttendance(subject, time, "Absent");
    btns[2].onclick = ()=>markAttendance(subject, time, "Cancelled");
    btns[3].onclick = (e)=>{ 
        e.stopPropagation(); // Prevent triggering other things
        addNote(subject); 
    };

    container.appendChild(div);
  });
}

// --- NEW NOTE FUNCTIONS ---
function addNote(subject) {
    const text = prompt(`Add a note for ${subject}:\n(e.g., "Assignment due Monday")`);
    if(text) {
        data.tasks.push({
            id: Date.now(),
            text: text,
            subject: subject,
            date: dateKey,
            done: false
        });
        save();
        renderTasks();
    }
}

function renderTasks() {
    const container = document.getElementById("taskList");
    const card = document.getElementById("taskCard");
    container.innerHTML = "";
    
    // Filter out deleted tasks
    const activeTasks = data.tasks; 

    if(activeTasks.length === 0) {
        card.style.display = "none";
        return;
    }
    
    card.style.display = "block";
    activeTasks.forEach((task, index) => {
        container.innerHTML += `
            <div class="task-item ${task.done ? 'task-done' : ''}" onclick="toggleTask(${index})">
                <div class="task-text">
                    ${task.text}
                    <span class="task-sub">${task.subject} ‚Ä¢ ${formatDateDDMMYYYY(task.date)}</span>
                </div>
                <button class="del-task-btn" onclick="deleteTask(event, ${index})">‚úñ</button>
            </div>
        `;
    });
}

function toggleTask(index) {
    data.tasks[index].done = !data.tasks[index].done;
    save();
    renderTasks();
}

function deleteTask(e, index) {
    e.stopPropagation(); // Prevent toggling
    if(confirm("Delete this note?")) {
        data.tasks.splice(index, 1);
        save();
        renderTasks();
    }
}

function markAttendance(subject,time,status){
  const key = dateKey+"_"+subject+"_"+time;
  if(data.locks[key]) return;
  data.locks[key] = true;
  data.history[dateKey] ??= [];
  data.history[dateKey].push({subject,time,status});
  if(status !== "Cancelled"){
    data.totals[subject] ??= {p:0,t:0};
    data.totals[subject].t++;
    if(status==="Present") data.totals[subject].p++;
  }
  save(); render();
}

function markExtra(status){
  const noExtraKey = dateKey + "_NO_EXTRA";
  if(data.locks[noExtraKey]){ alert("Extra lectures already locked for today ‚ùå"); return; }
  const subject = document.getElementById("extraSubject").value;
  if(!subject) return; 
  const key = dateKey+"_EXTRA_"+subject;
  if(data.locks[key]) return alert("Already added bro üòë");
  data.locks[key]=true;
  data.history[dateKey] ??= [];
  data.history[dateKey].push({subject,time:"Extra",status});
  data.totals[subject] ??= {p:0,t:0};
  data.totals[subject].t++;
  if(status==="Present") data.totals[subject].p++;
  save(); render();
}

function renderSummary(){
  const div = document.getElementById("summary");
  div.innerHTML = "";
  let tp = 0, tt = 0;
  const target = MIN_ATTENDANCE / 100;

  for(let s in data.totals){
    const { p, t } = data.totals[s];
    const percent = t ? Math.round((p / t) * 100) : 0;
    tp += p; tt += t;
    let colorClass = "progress-green";
    if(percent < MIN_ATTENDANCE) colorClass = "progress-red";
    else if(percent < MIN_ATTENDANCE + 10) colorClass = "progress-yellow";

    let statusMsg = "", statusClass = "";
    if (t > 0) {
        if (percent >= MIN_ATTENDANCE) {
            const bunkable = Math.floor((p / target) - t);
            if(bunkable > 0){ statusMsg = `üéâ You can bunk <b>${bunkable}</b> classes safely.`; statusClass = "msg-safe"; } 
            else { 
               if(percent === 100){ statusMsg = `üíØ Perfect! Attend more to build a buffer.`; statusClass = "msg-safe"; }
               else { statusMsg = `‚ö† On the edge! Don't miss next class.`; statusClass = "msg-warning"; }
            }
        } else {
            const needed = Math.ceil( (target * t - p) / (1 - target) );
            statusMsg = `üö® Attend next <b>${needed}</b> classes to hit ${MIN_ATTENDANCE}%.`; statusClass = "msg-danger";
        }
    } else { statusMsg = "No classes yet."; statusClass = "msg-cancelled"; }

    div.innerHTML += `
      <div class="summary-item">
        <div class="subject-row"><div class="subject-name">${s}</div><div class="subject-stats">${p}/${t} (${percent}%)</div></div>
        <div class="progress-wrap"><div class="progress-bar-bg"><div class="progress-bar-fill ${colorClass}" style="width:${percent}%"></div></div></div>
        <div class="status-msg ${statusClass}">${statusMsg}</div>
      </div>`;
  }

  const overall = tt ? Math.round((tp / tt) * 100) : 0;
  let overallBarClass = "overall-green";
  let overallTextClass = "overall-green-text";
  if(overall < MIN_ATTENDANCE){ overallBarClass = "overall-red"; overallTextClass = "overall-red-text"; }
  else if(overall < MIN_ATTENDANCE + 10){ overallBarClass = "overall-yellow"; overallTextClass = "overall-yellow-text"; }

  let overallStatusMsg = "", overallStatusClass = "";
  if(tt > 0){
      if(overall >= MIN_ATTENDANCE){
          const overallBunkable = Math.floor((tp / target) - tt);
          if(overallBunkable > 0){ overallStatusMsg = `üéâ You can bunk <b>${overallBunkable}</b> classes in total.`; overallStatusClass = "msg-safe"; } 
          else { 
              if(overall === 100){ overallStatusMsg = `üíØ Perfect aggregate! Keep it up.`; overallStatusClass = "msg-safe"; }
              else { overallStatusMsg = `‚ö† Aggregate on the edge! Don't miss any class.`; overallStatusClass = "msg-warning"; }
          }
      } else {
          const overallNeeded = Math.ceil( (target * tt - tp) / (1 - target) );
          overallStatusMsg = `üö® Attend next <b>${overallNeeded}</b> classes to hit ${MIN_ATTENDANCE}% aggregate.`; overallStatusClass = "msg-danger";
      }
  } else { overallStatusMsg = "Start marking attendance to see predictions."; overallStatusClass = "msg-cancelled"; }

  div.innerHTML += `
    <div class="overall-container">
      <div class="overall-title">OVERALL ATTENDANCE</div>
      <div class="overall-bar-bg"><div class="overall-bar-fill ${overallBarClass}" style="width:${overall}%"></div></div>
      <div class="overall-percent ${overallTextClass}">${overall}%</div>
      <div class="status-msg ${overallStatusClass}" style="text-align:center; margin-top:8px;">${overallStatusMsg}</div>
    </div>`;
}

function undo(d,i){
  const h = data.history[d][i];
  const key = d+"_"+h.subject+"_"+h.time;
  delete data.locks[key];
  if(h.status!=="Cancelled"){ data.totals[h.subject].t--; if(h.status==="Present") data.totals[h.subject].p--; }
  data.history[d].splice(i,1); save(); render();
}

function resetAll(){
  const pass = prompt("Enter reset password:");
  if(pass!==PASSWORD) return alert("Wrong password üòà");
  localStorage.removeItem("attendance"); location.reload();
}

function getAllSubjects() {
  const set = new Set();
  Object.values(timetable).flat().forEach(x => set.add(x[1]));
  return [...set].sort();
}

function initExtra(){
  const subjects = getAllSubjects();
  document.getElementById("extraSubject").innerHTML = subjects.map(s=>`<option>${s}</option>`).join("");
}

// --- PAST ATTENDANCE ---
let pastBuffer = [], pastDateKey = "", pastDay = "";
function loadPastTimetable(){
  const input = document.getElementById("pastDate");
  const val = input.value;
  const container = document.getElementById("pastLectures");
  const extraDiv = document.getElementById("pastExtra");
  container.innerHTML = ""; extraDiv.innerHTML = ""; pastBuffer = [];
  if(!val) return;
  const selectedDate = new Date(val);
  const todayDate = new Date(today.toDateString());
  if(selectedDate >= todayDate){ alert("Only past dates allowed bro üòë"); input.value = ""; return; }
  pastDateKey = val;
  pastDay = selectedDate.toLocaleDateString("en-US",{weekday:"long"});
  if(data.history[pastDateKey]){ container.innerHTML = "Attendance already exists for this date üö´"; return; }
  
  const lectures = timetable[pastDay] || []; 
  if(lectures.length === 0){ container.innerHTML = "No lectures scheduled on this day üò¥"; }
  
  lectures.forEach(([time,subject])=>{
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `<b>${subject}</b> (${time})<br>
      <button class="present">Present</button><button class="absent">Absent</button><button class="cancelled">Cancelled</button>`;
    div.querySelectorAll("button").forEach(btn=>{
      btn.onclick = ()=>{
        pastBuffer = pastBuffer.filter(x=>!(x.subject===subject && x.time===time));
        pastBuffer.push({ subject, time, status: btn.innerText });
        div.classList.add("locked");
      };
    });
    container.appendChild(div);
  });
  const allSubjects = getAllSubjects();
  extraDiv.innerHTML = `<h4>‚ûï Extra Lecture</h4>
    <select id="pastExtraSubject">${allSubjects.map(s=>`<option>${s}</option>`).join("")}</select><br>
    <button class="present" onclick="addPastExtra('Present')">Present</button>
    <button class="absent" onclick="addPastExtra('Absent')">Absent</button>`;
}
function addPastExtra(status){
  const subject = document.getElementById("pastExtraSubject").value;
  if(pastBuffer.find(x=>x.subject===subject && x.time==="Extra")){ alert("Extra lecture already added üò§"); return; }
  pastBuffer.push({subject, time:"Extra", status});
}
function savePastAttendance(){
  if(!pastDateKey || !pastBuffer.length){ alert("Nothing to save bro üò∂"); return; }
  if(data.history[pastDateKey]){ alert("Attendance for this date already exists ‚ùå"); return; }
  data.history[pastDateKey] = [];
  pastBuffer.forEach(h=>{
    const lockKey = pastDateKey+"_"+h.subject+"_"+h.time;
    data.locks[lockKey] = true;
    data.history[pastDateKey].push(h);
    if(h.status !== "Cancelled"){ data.totals[h.subject] ??= {p:0,t:0}; data.totals[h.subject].t++; if(h.status==="Present") data.totals[h.subject].p++; }
  });
  save(); alert("Past attendance saved üîí"); location.reload();
}
function toggleUndo(){
  const sec = document.getElementById("undoSection");
  sec.style.display = sec.style.display === "none" ? "block" : "none";
  const div = document.getElementById("undoSection");
  div.innerHTML = "";
  if(!data.history[dateKey] || data.history[dateKey].length === 0){ div.innerHTML = "<i>No attendance to undo today</i>"; return; }
  data.history[dateKey].forEach((h,i)=>{
    div.innerHTML += `<div class="detail-item"><b>${h.subject}</b> | ${h.time} | <span class="status-${h.status}">${h.status}</span> <button onclick="undo('${dateKey}',${i})">Undo</button></div>`;
  });
}
function lockNoExtra(){ const key = dateKey + "_NO_EXTRA"; if(data.locks[key]) return; data.locks[key] = true; save(); render(); }
function getDayName(dateStr){ const d = new Date(dateStr + "T00:00:00"); return isNaN(d) ? "" : d.toLocaleDateString("en-US", { weekday: "long" }); }
function formatDateDDMMYYYY(isoDate){ if(!isoDate) return ""; const [y, m, d] = isoDate.split("-"); return `${d}/${m}/${y}`; }
function showWeekendMessage(day){
  const statusDiv = document.getElementById("dayStatus");
  if(day === "Saturday" || day === "Sunday"){ statusDiv.innerHTML = `<span style="background:#facc15;color:#1f2933;padding:4px 10px;border-radius:12px;font-size:13px;font-weight:bold;">üü° Weekend</span><div style="margin-top:6px;color:#9ca3af;">üò¥ No lectures scheduled for today</div>`; } 
  else { statusDiv.innerHTML = ""; }
}
function renderDetailView(){
  const mode = document.getElementById("viewMode").value;
  const filter = document.getElementById("filterArea");
  const result = document.getElementById("detailResult");
  filter.innerHTML = ""; result.innerHTML = "";
  if(mode === "date"){
    const dates = Object.keys(data.history).sort().reverse();
    if(!dates.length){ result.innerText = "No data yet üò¥"; return; }
    filter.innerHTML = `<select id="dateSelect" onchange="showDateWise()"><option value="">Select Date</option>${dates.map(d=>`<option value="${d}">${formatDateDDMMYYYY(d)}</option>`).join("")}</select>`;
  }
  if(mode === "subject"){
    const subjects = Object.keys(data.totals).sort();
    if(!subjects.length){ result.innerText = "No data yet üò¥"; return; }
    filter.innerHTML = `<select id="subjectSelect" onchange="showSubjectWise()"><option value="">Select Subject</option>${subjects.map(s=>`<option value="${s}">${s}</option>`).join("")}</select>`;
  }
}
function showDateWise(){
  const d = document.getElementById("dateSelect").value;
  if(!d || !data.history[d]) return;
  const result = document.getElementById("detailResult");
  result.innerHTML = `<div id="dateHeader" style="margin-bottom:6px;font-weight:bold;">Date: ${formatDateDDMMYYYY(d)} (${getDayName(d)})</div><div class="detail-list">`;
  data.history[d].forEach(h=>{ result.innerHTML += `<div class="detail-item"><b>${h.subject}</b> | ${h.time} | <span class="status-${h.status}">${h.status}</span></div>`; });
  result.innerHTML += `</div>`;
}
function showSubjectWise(){
  const sub = document.getElementById("subjectSelect").value;
  if(!sub) return;
  const result = document.getElementById("detailResult");
  result.innerHTML = `<div class="detail-list">`;
  Object.keys(data.history).sort().reverse().forEach(d=>{
    data.history[d].forEach(h=>{ if(h.subject === sub){ result.innerHTML += `<div class="detail-item"><b>${formatDateDDMMYYYY(d)} (${getDayName(d)})</b> | ${h.time} | <span class="status-${h.status}">${h.status}</span></div>`; } });
  });
  result.innerHTML += `</div>`;
}
function exportBackup(){
  const backup = { version: 7, timestamp: new Date().toISOString(), data: data };
  const blob = new Blob([JSON.stringify(backup, null, 2)],{ type: "application/json" });
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `attendance_backup_${dateKey}.json`; a.click(); URL.revokeObjectURL(a.href);
}
document.getElementById("importFile").addEventListener("change", function(e){
  const file = e.target.files[0]; if(!file) return;
  const reader = new FileReader();
  reader.onload = function(){
    try{ const backup = JSON.parse(reader.result); if(!backup.data){ alert("Invalid backup"); return; }
      if(!confirm("Replace data?")){ return; } data = backup.data; save(); render(); alert("Restored ‚úÖ");
    } catch(err){ alert("Error importing ‚ùå"); }
  }; reader.readAsText(file);
});

// --- SETTINGS MODAL LOGIC ---
const modal = document.getElementById("settingsModal");
function openSettings() {
  modal.style.display = "flex";
  document.getElementById("editDaySelect").value = day;
  renderEditRows();
}
function closeSettings() { modal.style.display = "none"; }

function renderEditRows() {
  const selectedDay = document.getElementById("editDaySelect").value;
  const container = document.getElementById("editContainer");
  container.innerHTML = "";
  const lectures = timetable[selectedDay] || [];
  lectures.forEach((lec, index) => {
    container.innerHTML += `
      <div class="edit-row">
        <input type="text" class="edit-input time-input" value="${lec[0]}" id="time_${index}">
        <input type="text" class="edit-input sub-input" value="${lec[1]}" id="sub_${index}">
        <button class="del-row-btn" onclick="delEditRow(${index})">üóë</button>
      </div>
    `;
  });
}
function addEditRow() {
  const selectedDay = document.getElementById("editDaySelect").value;
  timetable[selectedDay] ??= [];
  timetable[selectedDay].push(["00:00-00:00", "New Subject"]);
  renderEditRows();
}
function delEditRow(index) {
  const selectedDay = document.getElementById("editDaySelect").value;
  timetable[selectedDay].splice(index, 1);
  renderEditRows();
}
function saveNewTimetable() {
  const selectedDay = document.getElementById("editDaySelect").value;
  const container = document.getElementById("editContainer");
  const rows = container.querySelectorAll(".edit-row");
  const newDaySchedule = [];
  rows.forEach((row, index) => {
    const t = document.getElementById(`time_${index}`).value;
    const s = document.getElementById(`sub_${index}`).value;
    if(t && s) newDaySchedule.push([t, s]);
  });
  timetable[selectedDay] = newDaySchedule;
  localStorage.setItem("custom_timetable", JSON.stringify(timetable));
  alert(`Saved timetable for ${selectedDay} ‚úÖ`);
  initExtra(); render();
}
function restoreDefaultTimetable() {
  if(confirm("‚ö† Are you sure? This will reset all timetable edits.")){
    localStorage.removeItem("custom_timetable");
    timetable = JSON.parse(JSON.stringify(defaultTimetable));
    alert("Timetable restored to default üîÑ");
    location.reload();
  }
}

function render(){
  showWeekendMessage(day);
  document.getElementById("today").innerText = `${day} | ${formatDateDDMMYYYY(dateKey)}`;
  loadLectures(); 
  renderSummary();
  renderTasks(); // Render pending tasks

  const noExtraKey = dateKey + "_NO_EXTRA";
  if(data.locks[noExtraKey]){
    document.getElementById("extraSubject").disabled = true;
    document.querySelectorAll(".card button").forEach(btn=>{ 
        // Keep note button enabled, disable others
        if(btn.innerText.includes("Present") || btn.innerText.includes("Absent") || btn.innerText.includes("No Extra")){ 
            btn.disabled = true; 
        } 
    });
    document.getElementById("extraInfo").innerText = "‚úî No extra lectures confirmed for today";
  }
}

initExtra();
render();
</script>
</body>
</html>
