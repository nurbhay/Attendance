<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Attendance Pro</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<link rel="apple-touch-icon" href="icon.png">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* CORE STYLES */
:root { --bg-color: #0f172a; --card-bg: #1e293b; --text-main: #f8fafc; --text-muted: #94a3b8; --accent: #3b82f6; --green: #10b981; --red: #ef4444; --yellow: #f59e0b; --nav-height: 64px; --holiday-border: rgba(255, 255, 255, 0.2); }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-color); color: var(--text-main); margin: 0; padding: 0; padding-bottom: 90px; padding-top: 60px; -webkit-user-select: none; user-select: none; min-height: 100vh; overscroll-behavior-y: none; }

/* ICONS */
.icon { width: 20px; height: 20px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
.icon-sm { width: 16px; height: 16px; }
.icon-lg { width: 24px; height: 24px; }

/* LOGIN PAGE OVERLAY */
#loginPage {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: var(--bg-color); z-index: 9999;
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 30px; text-align: center;
}
.login-logo { width: 80px; height: 80px; background: var(--accent); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.5); }
.login-title { font-size: 24px; font-weight: 800; margin-bottom: 10px; }
.login-desc { color: var(--text-muted); font-size: 14px; margin-bottom: 40px; line-height: 1.5; }

/* APP HEADER */
.app-header { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; z-index: 100; border-bottom: 1px solid #334155; }
.app-title { font-size: 18px; font-weight: 700; }
.settings-btn { background: none; border: none; color: var(--text-main); width: 44px; height: 44px; display: flex; align-items: center; justify-content: center; border-radius: 50%; }

/* NAVIGATION */
.bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height); background: #1e293b; display: flex; justify-content: space-around; border-top: 1px solid #334155; z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
.nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; font-weight: 500; color: var(--text-muted); background: none; border: none; width: 33%; height: 100%; }
.nav-item.active { color: var(--accent); }

/* UI ELEMENTS */
.tab-content { display: none; padding: 15px; animation: fadeIn 0.2s ease-out; }
.tab-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }

.card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 16px; border: 1px solid #334155; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
.card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.card-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; margin: 0; }

.lecture-card { display: flex; flex-direction: column; position: relative; padding-left: 12px; }
.lecture-card::before { content: ""; position: absolute; left: 0; top: 12px; bottom: 12px; width: 4px; background: #475569; border-radius: 4px; }
.lecture-present::before { background: var(--green); }
.lecture-absent::before { background: var(--red); }
.lecture-cancelled::before { background: var(--text-muted); }
.lecture-card.locked { opacity: 0.6; pointer-events: none; }

.lec-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
.lec-time { font-size: 11px; color: var(--accent); font-weight: 700; background: rgba(59, 130, 246, 0.1); padding: 3px 8px; border-radius: 6px; }
.lec-subject { font-size: 15px; font-weight: 600; line-height: 1.4; flex: 1; margin-right: 10px; }

.action-row { display: flex; gap: 8px; margin-top: 8px; }
.btn-pill { flex: 1; padding: 10px; border-radius: 8px; border: none; font-weight: 600; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 6px; }
.present { background: rgba(16, 185, 129, 0.1); color: var(--green); border: 1px solid rgba(16, 185, 129, 0.2); }
.absent { background: rgba(239, 68, 68, 0.1); color: var(--red); border: 1px solid rgba(239, 68, 68, 0.2); }
.cancelled { background: #334155; color: var(--text-muted); }
.btn-block { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: 600; margin-top: 8px; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; }
.btn-primary { background: var(--accent); color: white; }
.btn-secondary { background: #334155; color: white; }
.btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--red); border: 1px solid var(--red); }
.btn-google { background: white; color: #333; }

/* CUSTOM DROPDOWN & INPUTS */
.custom-select-wrapper { position: relative; margin-bottom: 12px; }
.custom-select-wrapper select { display: none; }
.custom-select-trigger { display: flex; align-items: center; justify-content: space-between; padding: 12px 14px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; font-size: 14px; color: white; }
.custom-options { position: absolute; top: 100%; left: 0; right: 0; background: #1e293b; border: 1px solid #334155; border-radius: 8px; z-index: 200; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.2s; max-height: 250px; overflow-y: auto; margin-top: 6px; }
.custom-select-wrapper.open .custom-options { opacity: 1; visibility: visible; transform: translateY(0); }
.custom-option { padding: 12px; border-bottom: 1px solid #334155; font-size: 14px; }
.custom-option:hover { background: #334155; }
input { width: 100%; padding: 12px 14px; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 8px; margin-bottom: 12px; outline: none; }

/* TOAST & MODALS */
#toastBox { position: fixed; top: 75px; left: 50%; transform: translateX(-50%); z-index: 3000; width: 90%; max-width: 350px; pointer-events: none; }
.toast { background: #1e293b; color: white; padding: 12px 16px; border-radius: 12px; display: flex; align-items: center; gap: 10px; font-size: 14px; margin-bottom: 10px; border: 1px solid #334155; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5); pointer-events: auto; }
.toast.success { border-left: 4px solid var(--green); }
.toast.error { border-left: 4px solid var(--red); }
.confirm-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 4000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
.confirm-box { background: #1e293b; width: 85%; max-width: 320px; padding: 24px; border-radius: 16px; text-align: center; border: 1px solid #475569; }

/* SETTINGS MODAL */
#settingsModal { display: none; position: fixed; inset: 0; background: var(--bg-color); z-index: 5000; flex-direction: column; }
.settings-header { height: 60px; background: rgba(15, 23, 42, 0.95); border-bottom: 1px solid #334155; display: flex; align-items: center; padding: 0 16px; gap: 15px; }
.settings-body { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; }

/* SUMMARY BARS */
.summary-item { margin-bottom: 14px; }
.summary-header { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 8px; }
.progress-track { width: 100%; height: 6px; background: #334155; border-radius: 10px; overflow: hidden; }
.progress-fill { height: 100%; border-radius: 10px; }
</style>
</head>
<body>

<div id="loginPage">
    <div class="login-logo">
        <svg class="icon" style="width:40px; height:40px; color:white;" viewBox="0 0 24 24"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>
    </div>
    <div class="login-title">Attendance Pro</div>
    <div class="login-desc">Track your classes, monitor stats, and sync across devices effortlessly.</div>
    
    <button class="btn-block btn-google" onclick="loginWithGoogle()" style="max-width: 300px;">
        <svg class="icon" style="width:18px;height:18px;" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm5 11h-5v-2h3.26c-.48-1.72-2.07-3-4.26-3-2.49 0-4.5 2.01-4.5 4.5S8.51 16.5 11 16.5c1.46 0 2.76-.71 3.61-1.81l1.52 1.52c-1.28 1.6-3.23 2.62-5.13 2.62-3.87 0-7-3.13-7-7s3.13-7 7-7c1.93 0 3.68.79 4.95 2.05l-1.42 1.42C13.67 6.94 12.87 6.5 12 6.5c-3.03 0-5.5 2.47-5.5 5.5s2.47 5.5 5.5 5.5c2.14 0 4.02-1.29 4.74-3.18H12v-2h5.5v.68c0 .28-.05.54-.12.79z" fill="currentColor"/></svg>
        Sign in with Google
    </button>
    <button onclick="skipLogin()" style="background:none; border:none; color:var(--text-muted); font-size:12px; margin-top:20px; text-decoration:underline;">Continue as Guest</button>
</div>

<header class="app-header">
    <div class="app-title">Attendance Pro</div>
    <button class="settings-btn" onclick="openSettings()">
        <svg class="icon icon-lg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0 .33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
    </button>
</header>

<div id="tab-home" class="tab-content active">
    <div style="text-align:center; margin-bottom:20px;">
        <h2 id="today" style="font-size:14px; font-weight:500; color:var(--text-muted); margin:0;"></h2>
        <div id="dayStatus"></div>
    </div>
    <div id="lectures"></div>
    <div class="card">
        <div class="card-header"><h3 class="card-title">Extra Lecture</h3></div>
        <select id="extraSubject" class="custom-select-source"></select>
        <div class="action-row">
            <button class="btn-pill present" onclick="markExtra('Present')">Present</button>
            <button class="btn-pill absent" onclick="markExtra('Absent')">Absent</button>
        </div>
    </div>
</div>

<div id="tab-stats" class="tab-content">
    <div class="card"><canvas id="attendanceChart" style="height:200px;"></canvas></div>
    <div class="card"><div id="summary"></div></div>
</div>

<div id="tab-tools" class="tab-content">
    <div class="card">
        <div class="card-header"><h3 class="card-title">Cloud Sync</h3></div>
        <div style="display:flex; align-items:center; justify-content:space-between; margin-bottom:12px;">
            <div id="userDisplay" style="font-size:13px; font-weight:600;">Guest</div>
            <div id="syncStatus" style="font-size:11px; color:var(--text-muted);">Not synced</div>
        </div>
        <button class="btn-block btn-primary" onclick="syncData()">Sync Now</button>
        <button class="btn-block btn-secondary" onclick="logout()">Sign Out</button>
    </div>
    <div class="card">
        <div class="card-header"><h3 class="card-title">Data Management</h3></div>
        <button class="btn-block btn-secondary" onclick="exportBackup()">Export Backup</button>
        <button class="btn-block btn-danger" onclick="triggerReset()">Factory Reset</button>
    </div>
</div>

<nav class="bottom-nav">
    <button class="nav-item active" onclick="switchTab('home')"><span>Home</span></button>
    <button class="nav-item" onclick="switchTab('stats')"><span>Stats</span></button>
    <button class="nav-item" onclick="switchTab('tools')"><span>Tools</span></button>
</nav>

<div id="toastBox"></div>
<div id="confirmModal" class="confirm-overlay">
    <div class="confirm-box">
        <div id="confirmTitle" style="font-size:18px; font-weight:700; margin-bottom:8px;"></div>
        <div id="confirmDesc" style="font-size:14px; color:var(--text-muted); margin-bottom:24px;"></div>
        <div style="display:flex; gap:12px;">
            <button class="btn-pill btn-secondary" onclick="closeConfirm()">Cancel</button>
            <button class="btn-pill btn-primary" id="confirmYesBtn">Confirm</button>
        </div>
    </div>
</div>

<div id="settingsModal">
    <header class="settings-header">
        <span style="font-size:18px; font-weight:600;">Settings</span>
        <button onclick="closeSettings()" style="background:none; border:none; color:white; font-size:24px;">&times;</button>
    </header>
    <div class="settings-body">
        <div class="card">
            <label>Target Attendance (%)</label>
            <input type="number" id="targetInput">
            <label>Semester End Date</label>
            <input type="date" id="semEndInput">
            <button class="btn-block btn-primary" onclick="saveSettings()">Save</button>
        </div>
    </div>
</div>

<script>
// --- CONFIG & ICONS ---
const ICONS = {
    check: '<svg class="icon" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>',
    x: '<svg class="icon" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>'
};

// --- FIREBASE INIT ---
const firebaseConfig = {
  apiKey: "AIzaSyD_3PoAWTKc9yrNuW37MFBg2nhtFV3v4xM",
  authDomain: "attendancepro-f5017.firebaseapp.com",
  projectId: "attendancepro-f5017",
  storageBucket: "attendancepro-f5017.firebasestorage.app",
  messagingSenderId: "116879034772",
  appId: "1:116879034772:web:f20c9dc9dad7e7a2796781"
};

let auth, db, currentUser;
try {
    firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    db = firebase.firestore();
    
    // AUTH LISTENER: CONTROLS START SCREEN
    auth.onAuthStateChanged(user => {
        const loginPage = document.getElementById("loginPage");
        if (user) {
            currentUser = user;
            loginPage.style.display = "none"; // Hide login screen
            document.getElementById("userDisplay").innerText = user.displayName || user.email;
            syncData(); // Auto sync on load
        } else {
            currentUser = null;
            document.getElementById("userDisplay").innerText = "Guest Mode";
            // Only show login if NOT in guest mode (handled by skipLogin)
            if(!localStorage.getItem("guest_mode")) loginPage.style.display = "flex"; 
        }
    });
} catch(e) { console.error(e); }

function loginWithGoogle() {
    const provider = new firebase.auth.GoogleAuthProvider();
    auth.signInWithPopup(provider).catch(e => showToast(e.message, "error"));
}

function skipLogin() {
    localStorage.setItem("guest_mode", "true");
    document.getElementById("loginPage").style.display = "none";
}

function logout() {
    localStorage.removeItem("guest_mode");
    auth.signOut().then(() => window.location.reload());
}

// --- DATA & SYNC LOGIC (True Sync) ---
let data = JSON.parse(localStorage.getItem("attendance")) || { totals:{}, history:{}, locks:{}, tasks:[] };
const defaultTimetable = {
  Monday: [ ["11:00-12:00","Introduction to Cyber Law"], ["12:00-01:00","Artificial Intelligence"], ["01:30-03:30","Operating Systems Lab"], ["03:30-04:30","Operating Systems"], ["04:30-05:30","Entrepreneurship and Start-ups"] ],
  Tuesday: [ ["11:00-12:00","Introduction to Cyber Law"], ["12:00-01:00","Theory of Computation"], ["01:30-03:30","Artificial Intelligence Lab"], ["03:30-04:30","Operating Systems"], ["04:30-05:30","Business Communication"] ],
  Wednesday: [ ["11:00-01:00","Computer Skill Lab-1"], ["01:30-02:30","Theory of Computation"], ["02:30-03:30","Introduction to Cyber Law"], ["03:30-04:30","Artificial Intelligence"], ["04:30-05:30","Business Communication"] ],
  Thursday: [ ["11:00-12:00","Software Requirement Engineering"], ["12:00-01:00","Theory of Computation"], ["01:30-02:30","Operating Systems"], ["02:30-03:30","Artificial Intelligence"], ["03:30-04:30","Entrepreneurship and Start-ups"] ],
  Friday: [ ["11:00-01:00","Software Requirement Engineering"], ["01:30-02:30","Theory of Computation"], ["02:30-04:30","Report Writing & Presentation Skill"] ]
};
let timetable = JSON.parse(localStorage.getItem("custom_timetable")) || defaultTimetable;
let MIN_ATTENDANCE = parseInt(localStorage.getItem("target_percent")) || 75;

// CORE SYNC FUNCTION: PULL -> MERGE -> PUSH
function syncData() {
    if(!currentUser) return;
    const statusEl = document.getElementById("syncStatus");
    statusEl.innerText = "Syncing...";
    
    const userRef = db.collection("users").doc(currentUser.uid);
    
    userRef.get().then(doc => {
        if(doc.exists) {
            const cloud = doc.data().attendance;
            // MERGE HISTORY (Union)
            if(cloud && cloud.history) {
                Object.keys(cloud.history).forEach(date => {
                    if(!data.history[date]) {
                        data.history[date] = cloud.history[date]; // Take cloud if local missing
                    } else {
                        // If both exist, combine unique entries
                        const localSet = new Set(data.history[date].map(x => x.subject+x.time));
                        cloud.history[date].forEach(item => {
                            if(!localSet.has(item.subject+item.time)) {
                                data.history[date].push(item);
                            }
                        });
                    }
                });
            }
            // MERGE LOCKS
            if(cloud && cloud.locks) Object.assign(data.locks, cloud.locks);
            
            // RECALCULATE TOTALS (Safety step)
            recalculateTotals();
        }

        // PUSH MERGED DATA BACK
        userRef.set({
            attendance: data,
            lastUpdated: Date.now()
        }, { merge: true }).then(() => {
            statusEl.innerText = "Synced just now";
            localStorage.setItem("attendance", JSON.stringify(data)); // Save locally
            render();
        });
    }).catch(e => {
        console.error(e);
        statusEl.innerText = "Sync Failed (Offline)";
    });
}

function recalculateTotals() {
    data.totals = {};
    Object.keys(data.history).forEach(date => {
        data.history[date].forEach(h => {
            if(h.status !== "Cancelled") {
                data.totals[h.subject] ??= {p:0, t:0};
                data.totals[h.subject].t++;
                if(h.status === "Present") data.totals[h.subject].p++;
            }
        });
    });
}

function save() {
    localStorage.setItem("attendance", JSON.stringify(data));
    syncData(); // Trigger sync on every save
}

// --- APP LOGIC ---
const today = new Date();
const dateKey = today.toISOString().split('T')[0];
const dayName = today.toLocaleDateString("en-US", { weekday: "long" });

function render() {
    document.getElementById("today").innerText = `${dayName}, ${dateKey.split('-').reverse().join('/')}`;
    
    // LECTURES
    const container = document.getElementById("lectures");
    container.innerHTML = "";
    
    if (dayName === "Saturday" || dayName === "Sunday") {
        container.innerHTML = `<div style="text-align:center; padding:20px; opacity:0.7;">No lectures today (Weekend)</div>`;
    } else {
        (timetable[dayName] || []).forEach(([time, subject]) => {
            const lockKey = `${dateKey}_${subject}_${time}`;
            const locked = data.locks[lockKey];
            const div = document.createElement("div");
            div.className = `card lecture-card ${locked ? 'locked' : ''}`;
            
            // Check status
            let status = "";
            if (locked && data.history[dateKey]) {
                const entry = data.history[dateKey].find(h => h.subject === subject && h.time === time);
                if (entry) {
                    if (entry.status === "Present") div.classList.add("lecture-present");
                    if (entry.status === "Absent") div.classList.add("lecture-absent");
                    status = `<div style="font-size:12px; font-weight:bold; margin-top:5px;">${entry.status}</div>`;
                }
            }

            div.innerHTML = `
                <div class="lec-top"><span class="lec-time">${time}</span><div class="lec-subject">${subject}</div></div>
                ${status}
                <div class="action-row" style="display:${locked ? 'none' : 'flex'}">
                    <button class="btn-pill present" onclick="mark('${subject}','${time}','Present')">Present</button>
                    <button class="btn-pill absent" onclick="mark('${subject}','${time}','Absent')">Absent</button>
                    <button class="btn-pill cancelled" onclick="mark('${subject}','${time}','Cancelled')">Off</button>
                </div>`;
            container.appendChild(div);
        });
    }
    
    // SUMMARY
    renderSummary();
    renderChart();
    populateSelects();
}

function mark(subject, time, status) {
    const lockKey = `${dateKey}_${subject}_${time}`;
    if(data.locks[lockKey]) return;
    
    data.locks[lockKey] = true;
    data.history[dateKey] ??= [];
    data.history[dateKey].push({ subject, time, status });
    
    if(status !== "Cancelled") {
        data.totals[subject] ??= {p:0, t:0};
        data.totals[subject].t++;
        if(status === "Present") data.totals[subject].p++;
    }
    save();
    render();
}

function markExtra(status) {
    const subject = document.getElementById("extraSubject").value;
    if(!subject) return;
    mark(subject, "Extra", status);
}

function renderSummary() {
    const div = document.getElementById("summary");
    div.innerHTML = "";
    
    // SAFE LOOP LIMIT FOR PERFORMANCE
    const semEndStr = localStorage.getItem("sem_end_date");
    let futureSlots = {};
    if(semEndStr) {
        let cursor = new Date(); cursor.setDate(cursor.getDate() + 1);
        const end = new Date(semEndStr);
        let checks = 0;
        while(cursor <= end && checks < 365) { // Prevent infinite loop
            const dName = cursor.toLocaleDateString("en-US", {weekday:"long"});
            (timetable[dName] || []).forEach(l => {
                futureSlots[l[1]] = (futureSlots[l[1]] || 0) + 1;
            });
            cursor.setDate(cursor.getDate() + 1);
            checks++;
        }
    }

    let tp = 0, tt = 0;
    Object.keys(data.totals).forEach(s => {
        const {p, t} = data.totals[s];
        tp += p; tt += t;
        const per = t ? Math.round((p/t)*100) : 0;
        
        div.innerHTML += `
        <div class="summary-item">
            <div class="summary-header"><span>${s}</span><span>${per}%</span></div>
            <div class="progress-track"><div class="progress-fill" style="width:${per}%; background:${per >= MIN_ATTENDANCE ? '#10b981' : '#ef4444'}"></div></div>
        </div>`;
    });
    
    const overall = tt ? Math.round((tp/tt)*100) : 0;
    div.innerHTML = `<div style="text-align:center; padding:15px; background:linear-gradient(135deg, #1e293b, #0f172a); border-radius:12px; margin-bottom:20px; border:1px solid #475569;">
        <div style="font-size:12px; color:#94a3b8;">OVERALL ATTENDANCE</div>
        <div style="font-size:36px; font-weight:800; margin:10px 0; color:${overall>=MIN_ATTENDANCE?'#10b981':'#ef4444'}">${overall}%</div>
    </div>` + div.innerHTML;
}

// --- UTILS ---
function populateSelects() {
    const subjects = new Set();
    Object.values(timetable).flat().forEach(x => subjects.add(x[1]));
    const html = [...subjects].map(s => `<option>${s}</option>`).join("");
    document.getElementById("extraSubject").innerHTML = html;
    setupCustomSelects();
}

function setupCustomSelects() {
    // Basic wrapper to ensure styling works
    document.querySelectorAll('.custom-select-source').forEach(sel => sel.style.display = 'block');
}

function triggerReset() {
    showConfirm("Factory Reset?", "Delete all data from device and cloud?", () => {
        if(currentUser) db.collection("users").doc(currentUser.uid).delete();
        localStorage.clear();
        location.reload();
    });
}

function exportBackup() {
    const blob = new Blob([JSON.stringify(data)], {type: "application/json"});
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = "backup.json"; a.click();
}

// --- UI HELPERS ---
function switchTab(t) {
    document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
    document.getElementById('tab-'+t).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(e => e.classList.remove('active'));
    event.currentTarget.classList.add('active');
}
function openSettings() { document.getElementById("settingsModal").style.display = "flex"; }
function closeSettings() { document.getElementById("settingsModal").style.display = "none"; }
function showToast(m, t) { 
    const b = document.getElementById("toastBox"); 
    b.innerHTML = `<div class="toast ${t||'success'}">${m}</div>`; 
    setTimeout(() => b.innerHTML="", 3000); 
}
function showConfirm(t, d, cb) {
    document.getElementById("confirmTitle").innerText = t;
    document.getElementById("confirmDesc").innerText = d;
    document.getElementById("confirmModal").style.display = "flex";
    document.getElementById("confirmYesBtn").onclick = () => { cb(); document.getElementById("confirmModal").style.display="none"; };
}
function closeConfirm() { document.getElementById("confirmModal").style.display = "none"; }
function saveSettings() {
    const t = document.getElementById("targetInput").value;
    const e = document.getElementById("semEndInput").value;
    if(t) localStorage.setItem("target_percent", t);
    if(e) localStorage.setItem("sem_end_date", e);
    location.reload();
}
function renderChart() {
    const ctx = document.getElementById('attendanceChart');
    if(!ctx) return;
    // Simple Chart Render (Placeholder for full chart logic)
    new Chart(ctx, { type: 'line', data: { labels: ['Start', 'Now'], datasets: [{ data: [100, 80], borderColor: '#3b82f6' }] } });
}

// Service Worker Registration
if ("serviceWorker" in navigator) navigator.serviceWorker.register("./sw.js");

render();
</script>
</body>
</html>
