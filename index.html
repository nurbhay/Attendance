<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Attendance Pro</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0f172a">
<link rel="apple-touch-icon" href="icon.png">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<style>
/* CSS STYLES */
:root { --bg-color: #0f172a; --card-bg: #1e293b; --text-main: #f8fafc; --text-muted: #94a3b8; --accent: #3b82f6; --green: #10b981; --red: #ef4444; --yellow: #f59e0b; --nav-height: 64px; --holiday-border: rgba(255, 255, 255, 0.2); }
* { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-color); color: var(--text-main); margin: 0; padding: 0; padding-bottom: 90px; padding-top: 60px; -webkit-user-select: none; user-select: none; min-height: 100vh; overscroll-behavior-y: none; }
.icon { width: 20px; height: 20px; fill: none; stroke: currentColor; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
.icon-sm { width: 16px; height: 16px; }
.icon-lg { width: 24px; height: 24px; }
.app-header { position: fixed; top: 0; left: 0; right: 0; height: 60px; background: rgba(15, 23, 42, 0.95); backdrop-filter: blur(12px); display: flex; justify-content: space-between; align-items: center; padding: 0 20px; z-index: 100; border-bottom: 1px solid #334155; }
.app-title { font-size: 18px; font-weight: 700; }
.settings-btn { background: none; border: none; color: var(--text-main); cursor: pointer; border-radius: 50%; display: flex; align-items: center; justify-content: center; width: 44px; height: 44px; }
.bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: var(--nav-height); background: #1e293b; display: flex; justify-content: space-around; border-top: 1px solid #334155; z-index: 100; padding-bottom: env(safe-area-inset-bottom); }
.nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; font-size: 10px; font-weight: 500; color: var(--text-muted); background: none; border: none; width: 33%; height: 100%; }
.nav-item.active { color: var(--accent); }
.tab-content { display: none; padding: 15px; animation: fadeIn 0.2s ease-out; }
.tab-content.active { display: block; }
@keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
.card { background: var(--card-bg); border-radius: 16px; padding: 16px; margin-bottom: 16px; border: 1px solid #334155; }
.card-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 12px; }
.card-title { font-size: 16px; font-weight: 600; display: flex; align-items: center; gap: 8px; margin: 0; }
.lecture-card { display: flex; flex-direction: column; position: relative; padding-left: 12px; }
.lecture-card::before { content: ""; position: absolute; left: 0; top: 12px; bottom: 12px; width: 4px; background: #475569; border-radius: 4px; }
.lecture-present::before { background: var(--green); }
.lecture-absent::before { background: var(--red); }
.lecture-cancelled::before { background: var(--text-muted); }
.lecture-card.locked { opacity: 0.6; pointer-events: none; }
.lec-top { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
.lec-time { font-size: 11px; color: var(--accent); font-weight: 700; background: rgba(59, 130, 246, 0.1); padding: 3px 8px; border-radius: 6px; }
.lec-subject { font-size: 15px; font-weight: 600; line-height: 1.4; flex: 1; margin-right: 10px; }
.action-row { display: flex; gap: 8px; margin-top: 8px; }
.btn-pill { flex: 1; padding: 10px; border-radius: 8px; border: none; font-weight: 600; font-size: 13px; display: flex; align-items: center; justify-content: center; gap: 6px; }
.present { background: rgba(16, 185, 129, 0.1); color: var(--green); border: 1px solid rgba(16, 185, 129, 0.2); }
.absent { background: rgba(239, 68, 68, 0.1); color: var(--red); border: 1px solid rgba(239, 68, 68, 0.2); }
.cancelled { background: #334155; color: var(--text-muted); }
.note-btn { background: transparent; color: var(--text-muted); border: 1px solid #334155; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }
.custom-select-wrapper { position: relative; margin-bottom: 12px; }
.custom-select-wrapper select { display: none; }
.custom-select-trigger { display: flex; align-items: center; justify-content: space-between; width: 100%; padding: 12px 14px; background: #0f172a; border: 1px solid #334155; border-radius: 8px; font-size: 14px; color: white; }
.custom-options { position: absolute; top: 100%; left: 0; right: 0; background: #1e293b; border: 1px solid #334155; border-radius: 8px; z-index: 200; opacity: 0; visibility: hidden; transform: translateY(-10px); transition: all 0.2s; max-height: 250px; overflow-y: auto; margin-top: 6px; }
.custom-select-wrapper.open .custom-options { opacity: 1; visibility: visible; transform: translateY(0); }
.custom-option { padding: 12px; border-bottom: 1px solid #334155; font-size: 14px; }
.custom-option:hover { background: #334155; }
input { width: 100%; padding: 12px 14px; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 8px; margin-bottom: 12px; outline: none; }
.btn-block { width: 100%; padding: 12px; border-radius: 8px; border: none; font-weight: 600; margin-top: 8px; font-size: 14px; display: flex; align-items: center; justify-content: center; gap: 8px; }
.btn-primary { background: var(--accent); color: white; }
.btn-secondary { background: #334155; color: white; }
.btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--red); border: 1px solid var(--red); }
.btn-google { background: white; color: #333; }
#toastBox { position: fixed; top: 75px; left: 50%; transform: translateX(-50%); z-index: 3000; width: 90%; max-width: 350px; pointer-events: none; }
.toast { background: #1e293b; color: white; padding: 12px 16px; border-radius: 12px; display: flex; align-items: center; gap: 10px; font-size: 14px; margin-bottom: 10px; border: 1px solid #334155; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.5); pointer-events: auto; }
.toast.success { border-left: 4px solid var(--green); }
.toast.error { border-left: 4px solid var(--red); }
.confirm-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7); z-index: 4000; justify-content: center; align-items: center; backdrop-filter: blur(4px); }
.confirm-box { background: #1e293b; width: 85%; max-width: 320px; padding: 24px; border-radius: 16px; text-align: center; border: 1px solid #475569; }
.summary-item { display: flex; flex-direction: column; margin-bottom: 14px; padding-bottom: 14px; border-bottom: 1px solid #334155; }
.summary-header { display: flex; justify-content: space-between; font-size: 14px; margin-bottom: 8px; }
.progress-track { width: 100%; height: 6px; background: #334155; border-radius: 10px; overflow: hidden; }
.progress-fill { height: 100%; border-radius: 10px; }
.status-msg { font-size: 11px; margin-top: 6px; font-weight: 500; opacity: 0.9; display: flex; align-items: center; gap: 4px; }
.overall-card { background: linear-gradient(135deg, #1e293b 0%, #0f172a 100%); text-align: center; border: 1px solid #475569; padding: 20px; }
.overall-percent { font-size: 36px; font-weight: 800; margin: 10px 0; letter-spacing: -1px; }
.task-item { background: #0f172a; padding: 12px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; border-left: 3px solid var(--yellow); }
.task-done { opacity: 0.5; text-decoration: line-through; border-left-color: var(--green); }
.del-task-btn { background: none; border: none; color: var(--text-muted); cursor: pointer; padding: 4px; }
.text-green { color: var(--green); } .text-red { color: var(--red); } .text-yellow { color: var(--yellow); } .text-muted { color: var(--text-muted); }
.holiday-card { border: 2px dashed var(--holiday-border); background-color: rgba(30, 41, 59, 0.5); border-radius: 16px; padding: 30px 20px; text-align: center; margin-bottom: 24px; margin-top: 10px; }
.weekend-icon { font-size: 48px; margin-bottom: 12px; display: block; animation: float 3s ease-in-out infinite; }
.weekend-title { font-size: 18px; font-weight: 700; margin-bottom: 4px; }
@keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-6px); } 100% { transform: translateY(0px); } }
.cloud-status { display:flex; align-items:center; justify-content:space-between; background:#0f172a; padding:12px; border-radius:8px; border:1px solid #334155; margin-bottom:12px; }
.user-avatar { width:32px; height:32px; border-radius:50%; background:#334155; display:flex; align-items:center; justify-content:center; font-weight:bold; color:white; overflow:hidden; }
#settingsModal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: var(--bg-color); z-index: 5000; flex-direction: column; animation: slideUp 0.3s ease-out; }
.settings-header { height: 60px; background: rgba(15, 23, 42, 0.95); border-bottom: 1px solid #334155; display: flex; align-items: center; padding: 0 16px; gap: 15px; }
.settings-body { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; }
.settings-section-title { font-size: 12px; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin: 20px 0 10px 4px; }
@keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
.edit-row { display: flex; gap: 8px; margin-bottom: 10px; align-items: center; }

#loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
.login-logo { width: 80px; height: 80px; background: var(--accent); border-radius: 20px; display: flex; align-items: center; justify-content: center; margin-bottom: 20px; box-shadow: 0 10px 25px -5px rgba(59, 130, 246, 0.5); }
</style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-logo"><svg class="icon" style="width:40px; height:40px; color:white;" viewBox="0 0 24 24"><polyline points="9 11 12 14 22 4"></polyline><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg></div>
    <div style="font-size: 24px; font-weight: 800; margin-bottom: 10px;">Attendance Pro</div>
    <div style="color: var(--text-muted); font-size: 14px; margin-bottom: 40px; line-height: 1.5;">Track your classes, monitor stats, and sync across devices.</div>
    <button class="btn-block btn-google" onclick="loginWithGoogle()" style="max-width: 300px;">Sign in with Google</button>
    <button onclick="skipLogin()" style="background:none; border:none; color:var(--text-muted); font-size:12px; margin-top:20px; text-decoration:underline;">Continue as Guest</button>
</div>
<script>if(localStorage.getItem("was_logged_in") || localStorage.getItem("guest_mode")) { document.getElementById("loginOverlay").style.display = "none"; }</script>

<header class="app-header">
    <div class="app-title">Attendance Pro</div>
    <button class="settings-btn" onclick="openSettings()"><svg class="icon icon-lg" viewBox="0 0 24 24"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0 .33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg></button>
</header>

<div id="tab-home" class="tab-content active">
    <div style="display:flex; flex-direction:column; align-items:center; margin-bottom: 20px;"><h2 id="today" style="font-size: 14px; font-weight: 500; color: var(--text-muted); margin: 0;"></h2><div id="dayStatus" style="width: 100%; margin-top: 10px;"></div></div>
    <div id="lectures"></div>
    <div class="card" style="border: 1px dashed #475569;">
        <div class="card-header"><h3 class="card-title"><span class="icon-slot"></span> Extra Lecture</h3></div>
        <select id="extraSubject" class="custom-select-source"></select>
        <div class="action-row"><button class="btn-pill present" onclick="markExtra('Present')">Present</button><button class="btn-pill absent" onclick="markExtra('Absent')">Absent</button></div>
        <button class="btn-block btn-secondary" style="margin-top:10px;" onclick="lockNoExtra()">No Extra Classes Today</button>
    </div>
    <div class="card" id="taskCard" style="display:none;"><div class="card-header"><h3 class="card-title"><span class="icon-task"></span> Tasks & Notes</h3></div><div id="taskList"></div></div>
</div>

<div id="tab-stats" class="tab-content">
    <div class="card"><div class="card-header"><h3 class="card-title"><span class="icon-graph"></span> 30-Day Trend</h3></div><div style="height: 200px;"><canvas id="attendanceChart"></canvas></div></div>
    <div class="card"><div class="card-header"><h3 class="card-title"><span class="icon-chart"></span> Subject Summary</h3></div><div id="summary"></div></div>
</div>

<div id="tab-tools" class="tab-content">
    <div class="card">
        <div class="card-header"><h3 class="card-title"><span class="icon-db"></span> Cloud Sync</h3></div>
        <div class="cloud-status"><div style="display:flex; align-items:center; gap:10px;"><div class="user-avatar" id="userAvatar">U</div><div style="font-size:13px;"><div style="font-weight:600;" id="userName">Guest</div><div style="color:var(--text-muted); font-size:11px;" id="syncStatus">Not synced</div></div></div><button onclick="logout()" style="background:none; border:none; color:var(--red); font-size:11px; font-weight:600; cursor:pointer;">LOGOUT</button></div>
        <button class="btn-block btn-secondary" onclick="forceCloudSync()">Manual Sync</button>
    </div>
    <div class="card">
        <div class="card-header"><h3 class="card-title"><span class="icon-db"></span> Data & Backup</h3></div>
        <button class="btn-block btn-secondary" onclick="exportBackup()">Export Backup File</button>
        <input type="file" id="importFile" accept=".json" style="display:none"><button class="btn-block btn-secondary" onclick="document.getElementById('importFile').click()">Import Backup File</button>
        <div style="border-top: 1px solid #334155; margin-top: 20px; padding-top: 15px;"><button class="btn-block btn-danger" onclick="triggerReset()">Factory Reset App</button></div>
    </div>
</div>

<nav class="bottom-nav">
    <button class="nav-item active" onclick="switchTab('home')"><span id="navHome"></span><span>Home</span></button>
    <button class="nav-item" onclick="switchTab('stats')"><span id="navStats"></span><span>Stats</span></button>
    <button class="nav-item" onclick="switchTab('tools')"><span id="navTools"></span><span>Tools</span></button>
</nav>

<div id="toastBox"></div>
<div id="confirmModal" class="confirm-overlay"><div class="confirm-box"><div class="confirm-title" id="confirmTitle"></div><div class="confirm-desc" id="confirmDesc"></div><div class="confirm-actions"><button class="btn-pill btn-secondary" onclick="closeConfirm()">Cancel</button><button class="btn-pill btn-primary" id="confirmYesBtn">Confirm</button></div></div></div>
<div id="passwordModal" class="confirm-overlay"><div class="confirm-box"><div class="confirm-title">Security Check</div><div class="confirm-desc">Enter PIN to reset data.</div><input type="password" id="resetPasswordInput" placeholder="Enter PIN" maxlength="4" style="text-align:center;"><div class="confirm-actions"><button class="btn-pill btn-secondary" onclick="closePasswordModal()">Cancel</button><button class="btn-pill btn-danger" id="submitPasswordBtn">Reset</button></div></div></div>
<div id="settingsModal"><header class="settings-header"><button onclick="closeSettings()" style="background:none; border:none; color:white; font-size:24px;">&times;</button><span style="font-size: 18px; font-weight: 600; margin-left: 10px;">Settings</span></header><div class="settings-body"><div class="settings-section-title">General</div><div class="card"><label style="font-size:13px; color:var(--text-muted);">Target Attendance (%)</label><input type="number" id="targetInput" placeholder="75"><button class="btn-block btn-primary" onclick="saveSettings()">Save</button></div></div></div>

<script>
// ICONS
const ICONS={home:'<svg class="icon icon-lg" viewBox="0 0 24 24"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>',stats:'<svg class="icon icon-lg" viewBox="0 0 24 24"><line x1="18" y1="20" x2="18" y2="10"></line><line x1="12" y1="20" x2="12" y2="4"></line><line x1="6" y1="20" x2="6" y2="14"></line></svg>',tools:'<svg class="icon icon-lg" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>',slot:'<svg class="icon icon-lg" viewBox="0 0 24 24"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>',task:'<svg class="icon icon-lg" viewBox="0 0 24 24"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',chart:'<svg class="icon icon-lg" viewBox="0 0 24 24"><path d="M21.21 15.89A10 10 0 1 1 8 2.83"></path><path d="M22 12A10 10 0 0 0 12 2v10z"></path></svg>',graph:'<svg class="icon icon-lg" viewBox="0 0 24 24"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>',db:'<svg class="icon icon-lg" viewBox="0 0 24 24"><ellipse cx="12" cy="5" rx="9" ry="3"></ellipse><path d="M21 12c0 1.66-4 3-9 3s-9-1.34-9-3"></path><path d="M3 5v14c0 1.66 4 3 9 3s9-1.34 9-3V5"></path></svg>',check:'<svg class="icon icon-sm" viewBox="0 0 24 24"><polyline points="20 6 9 17 4 12"></polyline></svg>',x:'<svg class="icon icon-sm" viewBox="0 0 24 24"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>'};
document.getElementById('navHome').innerHTML=ICONS.home;document.getElementById('navStats').innerHTML=ICONS.stats;document.getElementById('navTools').innerHTML=ICONS.tools;document.querySelectorAll('.icon-slot').forEach(e=>e.innerHTML=ICONS.slot);document.querySelectorAll('.icon-task').forEach(e=>e.innerHTML=ICONS.task);document.querySelectorAll('.icon-chart').forEach(e=>e.innerHTML=ICONS.chart);document.querySelectorAll('.icon-graph').forEach(e=>e.innerHTML=ICONS.graph);document.querySelectorAll('.icon-db').forEach(e=>e.innerHTML=ICONS.db);

// --- FIREBASE CONFIGURATION ---
// IMPORTANT: Replace the object below with your ACTUAL config from Firebase Console
const firebaseConfig = {
    apiKey: "AIzaSyD_3PoAWTKc9yrNuW37MFBg2nhtFV3v4xM",
    authDomain: "attendancepro-f5017.firebaseapp.com",
    projectId: "attendancepro-f5017",
    storageBucket: "attendancepro-f5017.firebasestorage.app",
    messagingSenderId: "116879034772",
    appId: "1:116879034772:web:f20c9dc9dad7e7a2796781"
};

let auth, db, currentUser;
try {
    firebase.initializeApp(firebaseConfig);
    auth = firebase.auth();
    
    // FIX: FORCE LONG POLLING & DISABLE OFFLINE PERSISTENCE
    // This fixes "Client is Offline" errors caused by firewalls/cache
    db = firebase.firestore();
    db.settings({
        experimentalForceLongPolling: true,       // FORCE HTTP connection
        experimentalAutoDetectLongPolling: false, // DISABLE Auto-detect to prevent conflict
        merge: true 
    });
    // We intentionally DO NOT call enablePersistence() because it causes bugs in this state

    auth.onAuthStateChanged(user => {
        if(user) {
            currentUser = user;
            document.getElementById("loginOverlay").style.display="none";
            document.getElementById("userName").innerText = user.displayName || "User";
            localStorage.setItem("was_logged_in", "true");
            forceCloudSync();
        } else {
            currentUser = null;
            if(!localStorage.getItem("guest_mode")) document.getElementById("loginOverlay").style.display="flex";
        }
    });
} catch(e) { console.error("Firebase Init Error:", e); }

function loginWithGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(e=>showToast(e.message,'error')); }
function skipLogin() { localStorage.setItem("guest_mode","true"); document.getElementById("loginOverlay").style.display="none"; }
function logout() { localStorage.removeItem("was_logged_in"); localStorage.removeItem("guest_mode"); auth.signOut().then(()=>location.reload()); }

function forceCloudSync() {
    if(!currentUser) return;
    const s = document.getElementById("syncStatus"); s.innerText="Syncing...";
    // MERGE LOGIC
    db.collection("users").doc(currentUser.uid).get().then(doc => {
        let finalData = data;
        if(doc.exists) {
            const cloud = doc.data().attendance;
            if(cloud && cloud.history) {
                Object.keys(cloud.history).forEach(d => {
                    if(!finalData.history[d]) finalData.history[d] = cloud.history[d];
                    else {
                        const local = new Set(finalData.history[d].map(i=>i.subject+i.time));
                        cloud.history[d].forEach(i => { if(!local.has(i.subject+i.time)) finalData.history[d].push(i); });
                    }
                });
            }
            if(cloud.locks) Object.assign(finalData.locks, cloud.locks);
            // Re-calc totals
            finalData.totals={};
            Object.values(finalData.history).flat().forEach(h=>{
                if(h.status!=="Cancelled"){ finalData.totals[h.subject]??={p:0,t:0}; finalData.totals[h.subject].t++; if(h.status==="Present") finalData.totals[h.subject].p++; }
            });
        }
        data = finalData; localStorage.setItem("attendance",JSON.stringify(data)); render();
        db.collection("users").doc(currentUser.uid).set({ attendance: data, lastUpdated: Date.now() }, {merge:true})
        .then(() => s.innerText="Synced")
        .catch(e => { console.error(e); s.innerText="Sync Error (Check Rules)"; });
    }).catch(e => { console.error(e); s.innerText="Offline"; });
}

// APP LOGIC
let data = JSON.parse(localStorage.getItem("attendance")) || { totals:{}, history:{}, locks:{}, tasks:[] };
const defaultTimetable = { Monday: [ ["11:00-12:00","Introduction to Cyber Law"], ["12:00-01:00","Artificial Intelligence"], ["01:30-03:30","Operating Systems Lab"], ["03:30-04:30","Operating Systems"], ["04:30-05:30","Entrepreneurship and Start-ups"] ], Tuesday: [ ["11:00-12:00","Introduction to Cyber Law"], ["12:00-01:00","Theory of Computation"], ["01:30-03:30","Artificial Intelligence Lab"], ["03:30-04:30","Operating Systems"], ["04:30-05:30","Business Communication"] ], Wednesday: [ ["11:00-01:00","Computer Skill Lab-1"], ["01:30-02:30","Theory of Computation"], ["02:30-03:30","Introduction to Cyber Law"], ["03:30-04:30","Artificial Intelligence"], ["04:30-05:30","Business Communication"] ], Thursday: [ ["11:00-12:00","Software Requirement Engineering"], ["12:00-01:00","Theory of Computation"], ["01:30-02:30","Operating Systems"], ["02:30-03:30","Artificial Intelligence"], ["03:30-04:30","Entrepreneurship and Start-ups"] ], Friday: [ ["11:00-01:00","Software Requirement Engineering"], ["01:30-02:30","Theory of Computation"], ["02:30-04:30","Report Writing & Presentation Skill"] ] };
let timetable = JSON.parse(localStorage.getItem("custom_timetable")) || defaultTimetable;
let MIN_ATTENDANCE = parseInt(localStorage.getItem("target_percent")) || 75;

const today = new Date(); const dateKey = today.toISOString().split('T')[0]; const day = today.toLocaleDateString("en-US",{ weekday:"long" });

function render() {
    document.getElementById("today").innerText = `${day}, ${dateKey}`;
    const con = document.getElementById("lectures"); con.innerHTML="";
    (timetable[day]||[]).forEach(([time,sub]) => {
        const key = dateKey+"_"+sub+"_"+time; const locked = data.locks[key];
        const div = document.createElement("div"); div.className="card lecture-card "+(locked?"locked":"");
        let stat = "";
        if(locked && data.history[dateKey]) {
            const ent = data.history[dateKey].find(h=>h.subject===sub && h.time===time);
            if(ent) { div.classList.add(ent.status==="Present"?"lecture-present":ent.status==="Absent"?"lecture-absent":"lecture-cancelled"); stat=`<div style="font-size:12px; font-weight:bold;">${ent.status}</div>`; }
        }
        div.innerHTML=`<div class="lec-top"><span class="lec-time">${time}</span><div class="lec-subject">${sub}</div></div>${stat}<div class="action-row" style="display:${locked?'none':'flex'}"><button class="btn-pill present" onclick="mark('${sub}','${time}','Present')">Present</button><button class="btn-pill absent" onclick="mark('${sub}','${time}','Absent')">Absent</button><button class="btn-pill cancelled" onclick="mark('${sub}','${time}','Cancelled')">Off</button></div>`;
        con.appendChild(div);
    });
    renderSummary(); renderChart(); populateSelect();
}

function mark(sub, time, status) {
    const key = dateKey+"_"+sub+"_"+time; if(data.locks[key]) return;
    data.locks[key]=true; data.history[dateKey]??=[]; data.history[dateKey].push({subject:sub,time,status});
    if(status!=="Cancelled"){ data.totals[sub]??={p:0,t:0}; data.totals[sub].t++; if(status==="Present") data.totals[sub].p++; }
    save(); render(); showToast("Marked "+status);
}
function markExtra(status) { const s = document.getElementById("extraSubject").value; if(s) mark(s,"Extra",status); }
function save() { localStorage.setItem("attendance",JSON.stringify(data)); forceCloudSync(); }

function renderSummary() {
    const div = document.getElementById("summary"); div.innerHTML=""; let tp=0, tt=0;
    Object.keys(data.totals).forEach(s => {
        const {p,t} = data.totals[s]; tp+=p; tt+=t; const per = t?Math.round((p/t)*100):0;
        div.innerHTML+=`<div class="summary-item"><div class="summary-header"><span>${s}</span><span>${per}%</span></div><div class="progress-track"><div class="progress-fill" style="width:${per}%; background:${per>=MIN_ATTENDANCE?'#10b981':'#ef4444'}"></div></div></div>`;
    });
    const ov = tt?Math.round((tp/tt)*100):0; div.innerHTML = `<div class="overall-card"><div class="overall-percent" style="color:${ov>=MIN_ATTENDANCE?'#10b981':'#ef4444'}">${ov}%</div></div>` + div.innerHTML;
}

function populateSelect() { const s = new Set(); Object.values(timetable).flat().forEach(x=>s.add(x[1])); document.getElementById("extraSubject").innerHTML=[...s].map(o=>`<option>${o}</option>`).join(""); }
function switchTab(t) { document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active')); document.getElementById('tab-'+t).classList.add('active'); document.querySelectorAll('.nav-item').forEach(e=>e.classList.remove('active')); event.currentTarget.classList.add('active'); }
function showToast(m,t) { const b=document.getElementById("toastBox"); b.innerHTML=`<div class="toast ${t||'success'}">${m}</div>`; setTimeout(()=>b.innerHTML="",3000); }
function renderChart() { new Chart(document.getElementById('attendanceChart'), { type:'line', data:{ labels:['Start','Now'], datasets:[{ data:[100,80], borderColor:'#3b82f6' }] } }); }
function triggerReset() { if(confirm("Reset Everything?")) { if(currentUser) db.collection("users").doc(currentUser.uid).delete(); localStorage.clear(); location.reload(); } }
function exportBackup() { const a=document.createElement("a"); a.href=URL.createObjectURL(new Blob([JSON.stringify(data)])); a.download="backup.json"; a.click(); }
document.getElementById("importFile").onchange = e => { const r=new FileReader(); r.onload=()=> { data=JSON.parse(r.result); save(); render(); }; r.readAsText(e.target.files[0]); }
function openSettings() { document.getElementById("settingsModal").style.display="flex"; }
function closeSettings() { document.getElementById("settingsModal").style.display="none"; }
function saveSettings() { MIN_ATTENDANCE=document.getElementById("targetInput").value; localStorage.setItem("target_percent",MIN_ATTENDANCE); render(); closeSettings(); }

// --- SERVICE WORKER BYPASS ---
// Forces the browser to load the new code instead of the cached old code
if("serviceWorker" in navigator) {
    navigator.serviceWorker.getRegistrations().then(regs => {
        for(let reg of regs) reg.unregister(); // KILL OLD WORKERS
    });
}

render();
</script>
</body>
</html>
